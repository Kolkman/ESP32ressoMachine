<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" type="text/css" href="button.css" media="all" />
    <link rel="stylesheet" type="text/css" href="ESPresso.css" media="all" />
    <script src="gauge.min.js"></script>
    <script>



        function statusUpdate() {

            fetch('api/v1/status')
                .then(function (response) {
                    return response.json()
                })
                .then(function (data) {
                    parseState(data);
                })
                .catch(function (err) {
                    console.log('error' + err);
                });
        }



        fetch('api/v1/firmware')
            .then(function (response) {
                return response.json()
            })
            .then(function (data) {
                parseFirmware(data);
            })
            .catch(function (err) {
                console.log('error' + err);
            });


        function buildStatusLine(measure, value, verbatim) {
            divStatusLine = document.createElement("div");
            var divStatusMeasure = document.createElement("div");
            var divStatusValue = document.createElement("div");
            divStatusLine.setAttribute("class", "statusLine");

            divStatusMeasure.setAttribute("class", "measure");
            divStatusValue.setAttribute("class", "value");

            divStatusLine.setAttribute("id", measure)
            divStatusMeasure.setAttribute("id", measure);
            divStatusValue.setAttribute("id", measure)

            divStatusMeasure.innerHTML = verbatim;
            divStatusLine.appendChild(divStatusMeasure);
            divStatusValue.innerHTML = value;
            divStatusLine.appendChild(divStatusValue);
            return divStatusLine;

        }
        function parseState(data) {
            var thermometer = document.getElementById("thermometer");
            var powergauge = document.getElementById("powergauge");

            thermometer.setAttribute("data-value", data.measuredTemperature);
            var highlights = [
                { "from": 80, "to": data.targetTemperature - 5.0, "color": "rgba(0,0,255,1)" },
                { "from": data.targetTemperature - 5.0, "to": data.targetTemperature - 2.0, "color": "rgba(0, 0 , 255, .5)" },
                { "from": data.targetTemperature - 2.0, "to": data.targetTemperature - 1.0, "to": data.targetTemperature - 1.0, "color": "rgba(0, 0 , 255, .25)" },
                { "from": data.targetTemperature - 1.0, "to": data.targetTemperature + 1.0, "color": "rgba(0, 255 , 0, 1)" },
                { "from": data.targetTemperature + 1, "to": data.targetTemperature + 2, "color": "rgba(255, 0, 0, 0.25)" },
                { "from": data.targetTemperature + 2, "to": data.targetTemperature + 5, "color": "rgba(255, 0, 0, .5)" },
                { "from": data.targetTemperature + 5, "to": 120, "color": "rgba(255, 0, 0, 1)" }

            ];

            
            var logpwr=Math.log10(data.heaterPower)
            thermometer.setAttribute("data-highlights", JSON.stringify(highlights));
            powergauge.setAttribute("data-value", logpwr);

            if (0<logpwr && logpwr <= 0.5){powergauge.setAttribute("data-color-needle", "blue"); }

            if (0.5 <logpwr && logpwr <= 1.0){powergauge.setAttribute("data-color-needle", "cyan"); }

            if (1.0 <logpwr && logpwr <= 1.5){powergauge.setAttribute("data-color-needle", "green"); }

            if (1.5<logpwr && logpwr <= 2.0){powergauge.setAttribute("data-color-needle", "yellow"); }
            if (2.0<logpwr && logpwr <= 2.5){powergauge.setAttribute("data-color-needle", "orange"); }
            if (2.5<logpwr){powergauge.setAttribute("data-color-needle", "red"); }





            var pidModeSwitch = document.getElementById("toggle--pwr");
            var extCtrlSwitch = document.getElementById("toggle--pidext")

            if (data.powerOffMode) {
                pidModeSwitch.checked = false;
            } else {
                pidModeSwitch.checked = true;
            }


            if (data.externalControlMode) {

                extCtrlSwitch.checked = false;
            } else {

                extCtrlSwitch.checked = true;
            }





        }
        function parseFirmware(data) {
            var divFirmware = document.getElementById("firmware")
            divFirmware.innerHTML = "Firmware:" + data.version;
        }


        function pwrSwitch() {
            if (document.getElementById("toggle--pwr").checked) {
                // (Heater is OFF)
                fetch('/api/v1/set?powerOffMode=false');
            } else {
                // .(HEATER is ON)
                fetch('/api/v1/set?powerOffMode=true');
            }
        }

        function pidextSwitch() {
            if (document.getElementById("toggle--pidext").checked) {
                // (Heater is OFF)
                fetch('/api/v1/set?externalControlMode=false');
            } else {
                // .(External is ON)
                fetch('/api/v1/set?externalControlMode=true');

            }
        }



        statusUpdate();
        setInterval(statusUpdate, 2000);


    </script>
</head>

<body>
    <h1>ESPresso Machine</h1>
    <div class="gauges">
        <canvas id="thermometer" data-type="radial-gauge" data-width="300" data-height="300" data-units="&deg;C"
            data-title="Temperature" data-min-value="80" data-max-value="120"
            data-major-ticks="[80,85,90,95,100,105,110,115,120]" data-minor-ticks="2" data-stroke-ticks="true"
            data-ticks-angle="225" data-start-angle="67.5" data-color-major-ticks="#ddd" data-color-minor-ticks="#ddd"
            data-color-title="#eee" data-color-units="#ccc" data-color-numbers="#eee" data-color-plate="#222"
            data-border-shadow-width="0" data-borders="true" data-needle-type="arrow" data-needle-width="2"
            data-needle-circle-size="7" data-needle-circle-outer="true" data-needle-circle-inner="false"
            data-animation-duration="1500" data-animation-rule="linear" data-color-border-outer="#333"
            data-color-border-outer-end="#111" data-color-border-middle="#222" data-color-border-middle-end="#111"
            data-color-border-inner="#111" data-color-border-inner-end="#333" data-color-needle-shadow-down="#333"
            data-color-needle-circle-outer="#333" data-color-needle-circle-outer-end="#111"
            data-color-needle-circle-inner="#111" data-color-needle-circle-inner-end="#222"
            data-value-box-border-radius="0" data-color-value-box-rect="#222"
            data-color-value-box-rect-end="#333"></canvas>


        <canvas id="powergauge" data-type="linear-gauge" data-width="400" data-height="100" data-min-value="0" data-title="Heater Power"
            data-max-value="3" data-major-ticks="0,1,2,3" data-minor-ticks=".1" data-stroke-ticks="true"
            data-color-plate="#8881" data-border-shadow-width="0" data-borders="false" data-bar-begin-circle="false"
            data-tick-side="left" data-number-side="left" data-needle-side="left" data-needle-type="line"
            data-needle-width="5" data-color-needle="#0f0" data-color-needle-begin="cornsilk" data-animation-duration="1500"
            data-animation-rule="linear" data-animation-target="plate" data-bar-width="10" data-ticks-width="10"
            data-ticks-width-minor="5"
            data-color-title="cornsilk"
            data-color-numbers="cornsilk"
            ></canvas>
    </div>
    <div class="hardwareswitches">
        <div class="switchwrapper">
            <div class="switchlabel">Heater Powerswitch</div>
            <div class="toggle toggle--switch">
                <input type="checkbox" id="toggle--pwr" class="toggle--checkbox" onclick="pwrSwitch()">
                <label class="toggle--btn" for="toggle--pwr"><span class="toggle--feature" data-label-on="ON"
                        data-label-off="OFF"></span></label>
            </div>
        </div>

        <div class="switchwrapper">

            <div class="switchlabel">PID or External Control</div>
            <div class="toggle toggle--switch">
                <input type="checkbox" id="toggle--pidext" class="toggle--checkbox" onclick="pidextSwitch()">
                <label class="toggle--btn" for="toggle--pidext"><span class="toggle--feature" data-label-on="PID"
                        data-label-off="EXT"></span></label>
            </div>
        </div>


    </div>
    <div class=Settings><a href="./config" id="settingbutton">Settings</a></div>

    <div id="firmware"></div>



</body>

</html>