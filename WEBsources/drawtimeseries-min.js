const displayInterval=15;var para,svg,margin={top:10,right:60,bottom:30,left:60},width=1500-margin.left-margin.right,height=300-margin.top-margin.bottom,new_time=(new Date).getTime(),old_time=(new Date).getTime(),toTime=d3.scaleLinear().range(-15,0),xScale=d3.scaleLinear().range([0,width-margin.left-margin.right]),yScale=d3.scaleLinear().range([height-margin.top-margin.bottom,0]),y2Scale=d3.scaleLinear().range([height-margin.top-margin.bottom,0]),dataStore=[];function responsivefy(t){var e=d3.select(t.node().parentNode),a=parseInt(t.style("width")),r=parseInt(t.style("height")),n=a/r;function i(){var a=parseInt(e.style("width"));t.attr("width",a),t.attr("height",Math.round(a/n))}t.attr("viewBox","0 0 "+a+" "+r).attr("perserveAspectRatio","xMinYMid").call(i),d3.select(window).on("resize."+e.attr("id"),i)}fetch(url+"/api/v1/get?PidInterval").then((function(t){return t.json()})).then((function(t){t.PidInterval})).catch((function(t){})),window.addEventListener("load",(function(){d3.json(url+"/api/v1/statistics").then((function(t){(svg=d3.select("#graph").append("svg").attr("width",width).attr("height",height+margin.top+margin.bottom).call(responsivefy).append("g").attr("transform","translate("+margin.left+","+margin.top+")")).append("text").attr("transform","translate("+width/2+" ,"+(height+margin.top)+")").style("text-anchor","middle").text("relative time (min)").attr("font-size","110%"),svg.append("text").attr("transform","translate("+(0-margin.left)+" ,"+height/2+"),rotate(-90)").style("text-anchor","middle").attr("dy","1em").style("text-anchor","middle").text("Temperature (Â°C)").attr("font-size","110%"),svg.append("text").attr("transform","translate("+(width-margin.right)+" ,"+(height/2+margin.top)+"),rotate(90)").style("text-anchor","middle").attr("dy","1em").text("Power").attr("font-size","110%"),CalculateAxes(dataStore=t),drawAxes(),init_visualize(dataStore),old_time=(new Date).getTime()}))}));var source=new EventSource(url+"/events");function CalculateAxes(t){t=t.sort((function(t,e){return parseInt(t.t)-parseInt(e.t)})),xMax=d3.max(t,(function(t){return parseInt(t.t)})),xScale.domain([-15,0]),yScaleMin=d3.min(t,(function(t){return parseFloat(t.T)})),yScaleMax=d3.max(t,(function(t){return parseFloat(t.T)})),y2ScaleMin=d3.min(t,(function(t){return parseFloat(t.p)})),y2ScaleMax=d3.max(t,(function(t){return parseFloat(t.p)})),yScaleMin-=.1,yScaleMax+=.1,y2ScaleMin-=50,y2ScaleMax+=40,y2ScaleMin<0&&(y2ScaleMin=0),yScale.domain([yScaleMin,yScaleMax]),y2Scale.domain([y2ScaleMin,y2ScaleMax])}function drawAxes(){svg.append("g").attr("class","x axis").attr("transform","translate(0,"+(height-margin.top-margin.bottom)+")").call(d3.axisBottom(xScale)),svg.append("g").attr("class","y axis").call(d3.axisLeft(yScale)),svg.append("g").attr("class","y2 axis").attr("transform","translate("+(width-margin.right-margin.left)+",0)").call(d3.axisRight(y2Scale))}function deleteAxes(){svg.selectAll(".y.axis").remove(),svg.selectAll(".y2.axis").remove(),svg.selectAll(".x.axis").remove()}function init_visualize(t){svg.append("defs").append("clipPath").attr("id","clip").append("rect").attr("width",width).attr("height",height),svg.append("g").attr("clip-path","url(#clip)").append("path").attr("id","temperaturePath").datum(t).join().attr("fill","none").attr("stroke","steelblue").attr("stroke-width",2.5).attr("d",d3.line().x((function(t){return xScale((parseInt(t.t)-xMax)/6e4)})).y((function(t){return yScale(parseFloat(t.T))}))),svg.append("path").attr("id","powerPath").datum(t).attr("fill","none").attr("stroke","red").attr("opacity",.5).attr("stroke-width",2.5).attr("d",d3.line().x((function(t){return xScale((parseInt(t.t)-xMax)/6e4)})).y((function(t){return y2Scale(parseFloat(t.p))})))}function visualize(t){d3.select("#temperaturePath").datum(t).join().attr("d",d3.line().x((function(t){return xScale((parseInt(t.t)-xMax)/6e4)})).y((function(t){return yScale(parseFloat(t.T))}))).attr("transform",null).transition().duration(.9*Math.abs(new_time-old_time)).ease(d3.easeLinear).attr("transform","translate("+xScale(-15-(new_time-old_time)/6e4)+")"),d3.select("#powerPath").datum(t).attr("d",d3.line().x((function(t){return xScale((parseInt(t.t)-xMax)/6e4)})).y((function(t){return y2Scale(parseFloat(t.p))}))).attr("transform",null).transition().duration(.9*Math.abs(new_time-old_time-20)).ease(d3.easeLinear).attr("transform","translate("+xScale(-15-(new_time-old_time)/6e4)+")")}source.addEventListener("open",(function(t){}),!1),source.addEventListener("error",(function(t){t.target.readyState,EventSource.OPEN}),!1),source.addEventListener("status",(function(t){const e=JSON.parse(t.data);var a={};for(a.t=e.time,a.T=e.measuredTemperature,a.p=e.heaterPower,dataStore.push(a),new_time=(new Date).getTime(),CalculateAxes(dataStore),deleteAxes(),drawAxes(),visualize(dataStore);a.t-dataStore[0].t>9e5;)dataStore.shift();old_time=new_time}),!1);